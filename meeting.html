<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jadwal Meeting</title>

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.55),
          rgba(0, 0, 0, 0.55)
        ),
        url("mas.png") no-repeat center/cover;
      color: #fff;
    }

    .logo {
      display: block;
      width: 130px;
      margin: 0 auto 10px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    #clock {
      margin-right: auto;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
    }

    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-login {
      background: #00d4ff;
      color: #000;
    }

    .btn-logout {
      background: #ff4d4d;
      color: #fff;
    }

    .container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .column {
      flex: 1;
      background: rgba(255, 255, 255, 0.15);
      padding: 16px;
      border-radius: 18px;
      min-width: 260px;
    }

    .column h3 {
      text-align: center;
      margin: 6px 0 14px;
    }

    .booking {
      background: rgba(255, 255, 255, 0.25);
      padding: 14px;
      border-radius: 14px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.25s;
    }

    .booking:hover {
      transform: scale(1.02);
      background: rgba(255, 255, 255, 0.35);
    }

    .icon-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-right: 6px;
    }

    .icon-delete {
      color: #ff4d4d;
    }

    .icon-edit {
      color: #00d4ff;
    }

    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00d4ff, #0090ff);
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      text-decoration: none;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;

      /* ‚úÖ BONUS BLUR */
      backdrop-filter: blur(8px);
    }

    /* ==================================================
       ‚úÖ UPDATED MODAL BOX DETAIL INTERAKTIF + BACKGROUND
    ================================================== */
    .modal-box {
      background: linear-gradient(
          rgba(0, 0, 0, 0.55),
          rgba(0, 0, 0, 0.55)
        ),
        url("citylight.png") no-repeat center/cover;

      color: #fff;
      padding: 26px;
      width: 360px;
      border-radius: 22px;

      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);

      animation: popup 0.35s ease;
    }

    @keyframes popup {
      from {
        transform: scale(0.85);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-box h3 {
      font-size: 20px;
      margin-bottom: 14px;
      text-align: center;
    }

    .modal-box p {
      font-size: 15px;
      margin: 10px 0;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.15);
    }

    .close {
      float: right;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      color: white;
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 6px 0;
    }
  </style>
</head>

<body>
  <!-- TOP BAR -->
  <div class="top-bar">
    <div id="clock">--</div>
    <button id="loginBtn" class="btn btn-login">@</button>
    <button id="logoutBtn" class="btn btn-logout" style="display: none">
      Logout
    </button>
  </div>

  <img src="map-log.png" class="logo" />

  <h1>
    Jadwal Peminjaman Ruang Meeting <br />
    PT Mitra Asa Pratama
  </h1>

  <!-- ROOM COLUMNS -->
  <div class="container">
    <div class="column">
      <h3>Ruang Arjuna</h3>
      <div id="arjuna"></div>
    </div>

    <div class="column">
      <h3>Ruang Srikandi</h3>
      <div id="srikandi"></div>
    </div>

    <div class="column">
      <h3>Ruang Gatot Kaca</h3>
      <div id="gatot"></div>
    </div>
  </div>

  <!-- ADD BUTTON -->
  <a href="daftar.html" class="fab" id="addBtn">+</a>

  <!-- DETAIL MODAL -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <span class="close" id="closeDetail">‚úñ</span>

      <h3 id="mAgenda"></h3>

      <p>üè¢ Ruangan: <b><span id="mRuangan"></span></b></p>
      <p>üìÖ Tanggal: <b><span id="mTanggal"></span></b></p>
      <p>‚è∞ Jam: <b><span id="mJam"></span></b></p>
      <p>üë§ Pemesan: <b><span id="mNama"></span></b></p>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal">
    <div class="modal-box">
      <h3>Login Admin</h3>
      <input type="password" id="pinInput" placeholder="Masukkan PIN" />
      <button class="btn btn-login" style="width: 100%" id="loginSubmit">
        Login
      </button>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3>Edit Jadwal</h3>

      <input type="hidden" id="eId" />
      <input id="eRuangan" placeholder="Ruangan" />
      <input id="eAgenda" placeholder="Agenda" />
      <input type="date" id="eTanggal" />
      <input type="time" id="eMulai" />
      <input type="time" id="eSelesai" />
      <input id="eNama" placeholder="Nama" />

      <button class="btn btn-login" style="width: 100%" id="editSubmit">
        Simpan
      </button>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const API_URL =
      "https://script.google.com/macros/s/AKfycby_Ib2KyhAnT9QuX4LIJ_JvK5WZB5edi4Tb4sy_4sx7MzaPs0wpxnMm7rS5vKFTzUSF/exec";

    const ADMIN_PIN_HASH =
      "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92";

    let ROLE = localStorage.getItem("role") || "user";
    let DATA = [];

    /* ===========================
       FORMAT TANGGAL
    =========================== */
    function formatTanggalIndo(tanggal) {
      const d = new Date(tanggal + "T00:00:00");
      return d.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    }

    /* ===========================
       LOGIN SYSTEM
    =========================== */
    loginBtn.onclick = () => (loginModal.style.display = "flex");

    logoutBtn.onclick = () => {
      ROLE = "user";
      localStorage.removeItem("role");
      updateUI();
      render();
    };

    loginSubmit.onclick = async () => {
      const hashBuffer = await crypto.subtle.digest(
        "SHA-256",
        new TextEncoder().encode(pinInput.value)
      );

      const pinHash = [...new Uint8Array(hashBuffer)]
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");

      if (pinHash === ADMIN_PIN_HASH) {
        ROLE = "admin";
        localStorage.setItem("role", "admin");
        loginModal.style.display = "none";
        updateUI();
        render();
      } else {
        alert("PIN salah!");
      }
    };

    function updateUI() {
      loginBtn.style.display = ROLE === "admin" ? "none" : "inline-block";
      logoutBtn.style.display = ROLE === "admin" ? "inline-block" : "none";
      addBtn.style.display = ROLE === "admin" ? "flex" : "none";
    }

    /* ===========================
       LOAD DATA
    =========================== */
    async function loadData() {
      const r = await fetch(API_URL + "?_=" + Date.now());
      DATA = await r.json();

      DATA.sort((a, b) => {
        const da = new Date(a.tanggal + "T" + a.mulai);
        const db = new Date(b.tanggal + "T" + b.mulai);
        return da - db;
      });

      render();
    }

    /* ===========================
       RENDER DATA
    =========================== */
    function render() {
      arjuna.innerHTML = "";
      srikandi.innerHTML = "";
      gatot.innerHTML = "";

      DATA.forEach((d) => {
        const el = document.createElement("div");
        el.className = "booking";

        el.innerHTML = `
          <b>${d.agenda}</b><br>
          üìÖ ${formatTanggalIndo(d.tanggal)}<br>
          ‚è∞ ${d.mulai} - ${d.selesai}<br>
          üë§ ${d.nama}

          ${
            ROLE === "admin"
              ? `
              <br><br>
              <button class="icon-btn icon-edit">‚úèÔ∏è Edit</button>
              <button class="icon-btn icon-delete">üóëÔ∏è Hapus</button>
            `
              : ""
          }
        `;

        el.onclick = () => openDetail(d);

        if (ROLE === "admin") {
          el.querySelector(".icon-edit").onclick = (e) => {
            e.stopPropagation();
            openEdit(d);
          };

          el.querySelector(".icon-delete").onclick = (e) => {
            e.stopPropagation();
            hapus(d.id);
          };
        }

        const r = d.ruangan.toLowerCase();
        if (r.includes("arjuna")) arjuna.appendChild(el);
        if (r.includes("srikandi")) srikandi.appendChild(el);
        if (r.includes("gatot")) gatot.appendChild(el);
      });
    }

    /* ===========================
       DETAIL MODAL
    =========================== */
    function openDetail(d) {
      mAgenda.textContent = d.agenda;
      mRuangan.textContent = d.ruangan;
      mTanggal.textContent = formatTanggalIndo(d.tanggal);
      mJam.textContent = d.mulai + " - " + d.selesai;
      mNama.textContent = d.nama;

      modal.style.display = "flex";
    }

    closeDetail.onclick = () => (modal.style.display = "none");

    /* ===========================
       EDIT MODAL
    =========================== */
    function openEdit(d) {
      eId.value = d.id;
      eRuangan.value = d.ruangan;
      eAgenda.value = d.agenda;
      eTanggal.value = d.tanggal;
      eMulai.value = d.mulai;
      eSelesai.value = d.selesai;
      eNama.value = d.nama;

      editModal.style.display = "flex";
    }

    editSubmit.onclick = async () => {
      const f = new FormData();
      f.append("action", "edit");

      f.append("id", eId.value);
      f.append("ruangan", eRuangan.value);
      f.append("agenda", eAgenda.value);
      f.append("tanggal", eTanggal.value);
      f.append("mulai", eMulai.value);
      f.append("selesai", eSelesai.value);
      f.append("nama", eNama.value);

      await fetch(API_URL, { method: "POST", body: f });

      editModal.style.display = "none";
      loadData();
    };

    /* ===========================
       DELETE
    =========================== */
    async function hapus(id) {
      if (!confirm("Hapus data ini?")) return;

      const f = new FormData();
      f.append("action", "delete");
      f.append("id", id);

      await fetch(API_URL, { method: "POST", body: f });
      loadData();
    }

    /* ===========================
       CLOCK
    =========================== */
    setInterval(() => {
      clock.textContent = new Date().toLocaleString("id-ID");
    }, 1000);

    updateUI();
    loadData();
  </script>
</body>
</html>
