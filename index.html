<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peminjaman Ruang Meeting – MAP</title>
  <link rel="icon" href="map-log.png" type="image/png">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <!-- Swiper.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  <!-- Swiper.js CSS -->
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
  <!-- Feather Icons & Tabletop -->
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/tabletop@1.5.1/tabletop.min.js"></script>

  <style>
    .sidebar { transition: transform 0.3s ease; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Lonceng Notifikasi -->
<div class="fixed top-4 right-4 z-50 text-sm">
  <button id="notif-btn" class="relative bg-white p-3 rounded-full shadow hover:bg-gray-100 transition focus:outline-none">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405C18.21 14.79 18 14.378 18 14V11c0-3.314-2.686-6-6-6S6 7.686 6 11v3c0 .378-.21.79-.595 1.595L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
    </svg>
    <span id="notif-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold px-1.5 py-0.5 rounded-full hidden">0</span>
  </button>

  <!-- Drop-down Notifikasi -->
  <div id="notif-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200">
    <div class="p-3 font-semibold border-b">📬 Pengajuan Baru</div>
    <ul id="notif-list" class="max-h-60 overflow-y-auto divide-y"></ul>
    <div class="text-center py-2 text-xs text-gray-500 bg-gray-50">Klik untuk tutup</div>
  </div>
</div>

<!-- BURGER BUTTON -->
<button id="btn-open" class="lg:hidden fixed top-4 left-4 z-50 p-3 bg-gray-600 text-white rounded-full hover:bg-gray-500">
  <i data-feather="menu"></i>
</button>

<!-- OVERLAY -->
<div id="overlay" class="fixed inset-0 bg-black/40 hidden z-40 lg:hidden"></div>

<!-- SIDEBAR -->
<aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-gray-900 text-white z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
  <!-- HEADER -->
  <div class="flex items-center justify-between p-4 border-b border-gray-700">
    <div class="flex items-center gap-2">
      <img src="map-log.png" alt="Logo MAP" class="h-10 w-auto rounded shadow" />
      <span class="font-semibold text-lg"></span>
    </div>
    <!-- BUTTON CLOSE -->
    <button id="btn-close" class="lg:hidden p-2 rounded hover:bg-gray-800">
      <i data-feather="x"></i>
      <span class="sr-only">Tutup menu</span>
    </button>
  </div>

  <!-- MENU -->
  <nav class="mt-4 space-y-1 px-4">
    <a href="kalender.html" class="block py-2 px-4 rounded hover:bg-indigo-600 transition">🗓️ Kalendar</a>
    <a href="list_booking.html" class="block py-2 px-4 rounded hover:bg-indigo-600 transition">📄 List Booking</a>
    <a href="daftar.html" class="block py-2 px-4 rounded hover:bg-indigo-600 transition">📄 Ajukan</a>
  </nav>
</aside>

<!-- SCRIPT -->
<script>
  const btnOpen = document.getElementById("btn-open");
  const btnClose = document.getElementById("btn-close");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");

  // Buka sidebar
  btnOpen.addEventListener("click", () => {
    sidebar.classList.remove("-translate-x-full");
    overlay.classList.remove("hidden");
  });

  // Tutup sidebar
  btnClose.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  });

  // Klik di luar sidebar (overlay)
  overlay.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  });

  // Tutup sidebar saat klik menu di dalam sidebar (khusus mobile)
  document.querySelectorAll("#sidebar nav a").forEach(link => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 1024) {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
      }
    });
  });
</script>

<!-- Feather Icons Init -->
<script>
  feather.replace();
</script>


<!-- KONTEN UTAMA -->
<div class="flex-1 flex flex-col lg:ml-64">

  <!-- HEADER -->
  <header class="bg-indigo-700 text-white shadow sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">
      <img src="logo.jpg" class="h-9 w-auto rounded shadow" />
      <h1 class="text-xl font-bold text-center flex-1">Peminjaman Ruang Meeting</h1>
      <div class="w-9"></div>
    </div>
  </header>

  <main class="p-4 space-y-6">
<style>
    body {
      font-family: sans-serif;
      background: #f9fafb;
      padding: 20px;
    }
    .swiper-container {
      width: 100%;
      max-width: 800px;
      margin: auto;
    }
    .swiper-slide {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .title {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h1 class="title">Agenda Meeting</h1>
  <div class="swiper-container">
    <div class="swiper-wrapper">
      <div class="swiper-slide" id="kemarin">
        <h2>Kemarin</h2>
        <div class="content"></div>
      </div>
      <div class="swiper-slide" id="hariini">
        <h2>Hari Ini</h2>
        <div class="content"></div>
      </div>
      <div class="swiper-slide" id="besok">
        <h2>Besok</h2>
        <div class="content"></div>
      </div>
      <div class="swiper-slide" id="lusa">
        <h2>Lusa</h2>
        <div class="content"></div>
      </div>
    </div>
    <div class="swiper-pagination"></div>
  </div>

  <script>
    const supabaseUrl = 'https://mypiqbkyiwcxhznclbcl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGlxYmt5aXdjeGh6bmNsYmNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Njg5ODQsImV4cCI6MjA2OTM0NDk4NH0.qz7vdrG9IqQXgxFqPw16_P5JUrNlqqN_BsgA66s-yv8';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const today = new Date();
    const dates = {
      kemarin: new Date(today),
      hariini: new Date(today),
      besok: new Date(today),
      lusa: new Date(today),
    };
    dates.kemarin.setDate(today.getDate() - 1);
    dates.besok.setDate(today.getDate() + 1);
    dates.lusa.setDate(today.getDate() + 2);

    const formatDate = (date) => date.toISOString().split('T')[0];

    async function fetchAgenda(label, tanggal) {
      const { data, error } = await supabase
        .from('peminjaman')
        .select('*')
        .eq('tanggal', tanggal)
        .order('jam_mulai', { ascending: true });

      const container = document.querySelector(`#${label} .content`);
      container.innerHTML = '';
      if (error) {
        container.innerHTML = `<p style="color:red">Gagal memuat data</p>`;
        return;
      }

      if (data.length === 0) {
        container.innerHTML = '<p>Tidak ada agenda</p>';
        return;
      }

      data.forEach(item => {
        container.innerHTML += `
          <div class="item">
            <strong>${item.nama}</strong> (${item.departemen})<br>
            ${item.ruangan} - ${item.agenda}<br>
            ${item.jam_mulai} - ${item.jam_selesai}
          </div>
        `;
      });
    }

    for (const [key, date] of Object.entries(dates)) {
      fetchAgenda(key, formatDate(date));
    }

    new Swiper('.swiper-container', {
      slidesPerView: 1,
      spaceBetween: 20,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });
  </script>
</body>

  </main>
<!-- Tombol Ajukan Peminjaman -->
<div class="fixed bottom-24 right-4 sm:static sm:mb-4 sm:mr-4 sm:flex sm:justify-end z-40">
  <a href="daftar.html"target="_blank" rel="noopener"
     class="inline-flex items-center gap-2 px-4 py-2 sm:px-5 sm:py-2 rounded-full
            bg-indigo-500 hover:bg-indigo-500 active:scale-95
            text-white text-sm sm:text-base font-semibold shadow-lg transition-transform">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 4v16m8-8H4"/>
    </svg>
    <span class="hidden sm:inline">Ajukan Peminjaman</span>
    <span class="sm:hidden">Ajukan</span>
  </a>
</div>

  <!-- FOOTER -->
  <footer class="mt-auto">
    <div class="bg-indigo-600 text-white py-4 text-center text-sm">
      <i data-feather="shield" class="inline-block w-4 h-4 mr-1"></i>
      © 2025 Mitra Asa Pratama
    </div>
  </footer>
</div>
<!-- SCRIPT UTAMA -->
<script>
  feather.replace();

  // Sidebar Toggle
  document.getElementById("btn-open").onclick = () => {
    document.getElementById("sidebar").classList.remove("-translate-x-full");
    document.getElementById("overlay").classList.remove("hidden");
  };
  document.getElementById("btn-close").onclick = () => {
    document.getElementById("sidebar").classList.add("-translate-x-full");
    document.getElementById("overlay").classList.add("hidden");
  };

  // Fetch data dari Google Sheets
  document.addEventListener('DOMContentLoaded', function () {
    Tabletop.init({
      key: '1aRLwWmM0UR8RM2xhsFFafBSHIoBWddyvNtdoMnuQijA',
      simpleSheet: true,
      callback: function (data) {
        const calendarContainer = document.getElementById('calendarEvents');
        const meetingToday = document.getElementById('meetingCard');
        const today = new Date().toISOString().split('T')[0];
        let todayMeetings = '';

        data.forEach(item => {
          // Slider Semua Jadwal
          const slide = document.createElement('div');
          slide.className = 'swiper-slide bg-white rounded-xl shadow p-4';
          slide.innerHTML = slide.innerHTML = 
  <div class="text-center">
    <div class="text-xl font-bold text-gray-800">${item.tanggal}</div>
    <div class="mt-2 text-lg text-gray-600">${item.agenda}</div>
    <div class="mt-1 text-sm text-gray-500">${item.jam_mulai} - ${item.jam_selesai}</div>
    <div class="mt-1 text-sm text-gray-500">Ruangan: ${item.ruangan}</div>
    <div class="mt-1 text-sm text-gray-500">PIC: ${item.nama} (${item.departemen})</div>
  </div>
            <h4 class="font-bold text-indigo-600">${item['Nama Ruangan'] || 'Ruang'}</h4>
            <p>📅 ${item['Tanggal']} – ⏰ ${item['Waktu Mulai']} s/d ${item['Waktu Selesai']}</p>
            <p class="mt-1 font-semibold">${item['Judul Meeting'] || ''}</p>
            <p class="text-sm text-gray-500">PIC: ${item['Nama Pemesan'] || '-'}</p>;
          calendarContainer.appendChild(slide);

          // Filter untuk hari ini
          if (item['Tanggal'] === today) {
            todayMeetings += 
              <div class="border-b pb-1">
                <p class="font-semibold text-indigo-700">${item['Judul Meeting']}</p>
                <p class="text-sm">⏰ ${item['Waktu Mulai']} - ${item['Waktu Selesai']} | ${item['Nama Ruangan']}</p>
              </div>;
          }
        });

        meetingToday.innerHTML = todayMeetings || '<p class="text-gray-500">Tidak ada meeting hari ini.</p>';

        // Init Swiper
        new Swiper('.mySwiper', {
          slidesPerView: 1,
          spaceBetween: 20,
          pagination: { el: '.swiper-pagination', clickable: true },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });
      });
    });
  });
</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabaseUrl = 'https://mypiqbkyiwcxhznclbcl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cGlxYmt5aXdjeGh6bmNsYmNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3Njg5ODQsImV4cCI6MjA2OTM0NDk4NH0.qz7vdrG9IqQXgxFqPw16_P5JUrNlqqN_BsgA66s-yv8'; 
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const notifBtn = document.getElementById('notif-btn');
  const notifBadge = document.getElementById('notif-count');
  const notifList = document.getElementById('notif-list');
  const notifDropdown = document.getElementById('notif-dropdown');

  let notifData = [];

  function updateBadge() {
    if (notifData.length > 0) {
      notifBadge.textContent = notifData.length;
      notifBadge.classList.remove("hidden");
    } else {
      notifBadge.classList.add("hidden");
    }
  }

  function updateDropdown() {
    notifList.innerHTML = "";
    if (notifData.length === 0) {
      notifList.innerHTML = <li class="p-3 text-gray-500 text-sm">Tidak ada pengajuan baru</li>;
      return;
    }

    notifData.slice(-3).reverse().forEach(item => {
      const li = document.createElement("li");
      li.className = "p-3 text-gray-700 text-sm";
      li.innerHTML = <strong>${item.nama}</strong> meminjam <strong>${item.ruangan}</strong><br><span class="text-xs text-gray-500">${item.jam_mulai} - ${item.jam_selesai}</span>;
      notifList.appendChild(li);
    });
  }

  // Toggle dropdown
  notifBtn.addEventListener("click", () => {
    notifDropdown.classList.toggle("hidden");
    notifData = []; // reset
    updateBadge();
    updateDropdown();
  });

  // Listener realtime dari Supabase
  supabase
    .channel('notif-peminjaman')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'peminjaman',
    }, payload => {
      const row = payload.new;
      notifData.push(row);
      updateBadge();
      updateDropdown();
      console.log("🔔 New submission:", row);
    })
    .subscribe();
</script>

</body>
</html>
